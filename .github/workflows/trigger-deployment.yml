name: Trigger Deployment

on:
  push:
    branches: [dev, staging, main]
  pull_request:
    branches: [dev, staging, main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      environment: ${{ steps.env.outputs.environment }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed services
      id: changes
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
        elif [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
          BASE_SHA="${{ github.event.before }}"
        else
          # First push or force push - compare with HEAD~1 or use all files
          BASE_SHA="HEAD~1"
        fi
        
        # Ensure we have the base commit
        if ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
          echo "Base SHA not found, using HEAD~1"
          BASE_SHA="HEAD~1"
        fi
        
        CHANGED_FILES=$(git diff --name-only $BASE_SHA ${{ github.sha }} 2>/dev/null || git ls-files)
        SERVICES=()
        
        for service in services/user-service services/event-service services/notification-service services/api-gateway; do
          service_name=$(basename $service)
          if echo "$CHANGED_FILES" | grep -q "^$service/"; then
            SERVICES+=("\"$service_name\"")
          fi
        done
        
        # If shared libs changed, rebuild all services
        if echo "$CHANGED_FILES" | grep -qE "^shared/(common-lib|security-lib|messaging-lib)/"; then
          SERVICES=("\"user-service\"" "\"event-service\"" "\"notification-service\"" "\"api-gateway\"")
        fi
        
        SERVICES_JSON="[$(IFS=,; echo "${SERVICES[*]}")]"
        echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT

    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
          echo "environment=dev" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi

  trigger-deployment:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    steps:
    - name: Trigger DevOps Pipeline
      run: |
        echo "Triggering deployment for services: ${{ needs.detect-changes.outputs.services }}"
        echo "Environment: ${{ needs.detect-changes.outputs.environment }}"
        
        response=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Authorization: token ${{ secrets.DEVOPS_REPO_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ secrets.DEVOPS_REPO_OWNER }}/devops-repo/dispatches \
          -d '{
            "event_type": "backend-deployment",
            "client_payload": {
              "repository": "${{ github.repository }}",
              "sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "environment": "${{ needs.detect-changes.outputs.environment }}",
              "services": ${{ needs.detect-changes.outputs.services }},
              "actor": "${{ github.actor }}"
            }
          }')
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n -1)
        
        if [ "$http_code" -eq 204 ]; then
          echo "✅ Successfully triggered DevOps pipeline"
        else
          echo "❌ Failed to trigger pipeline. HTTP code: $http_code"
          echo "Response: $body"
          exit 1
        fi